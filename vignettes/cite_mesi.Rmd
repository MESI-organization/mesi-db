---
title: "Cite original publications"
author: "Jan Ziegler and Benjamin Stocker"
date: "2024-07-1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = FALSE)
```

This vignette demonstrates how to create an experiments reference table to be included in a PDF document with full citation information of original publications. The workflow is based on Latex.

## Environment

Load libraries and R source code for this repository's functions.
```{r}
library(tidyverse)
library(here)
library(xtable)
library(bib2df)

source(here("R/create_table_latex.R"))
source(here("R/process_cite_lines.R"))
```

## Create table as R dataframe

Read and subset citation data. The list should contain the experiments and citations used in your analysis.
```{r}
# Read mesi db 
mesi_bibliography <- read_csv(here("data/mesi_bibliography.csv"), show_col_types = FALSE) 

# Read the BibTeX file
bib_file <- bib2df(here("latex/mesi.bib"))

# Extract citation keys from the BibTeX file
    citation_keys <- bib_file$BIBTEXKEY

# Filter the mesi database for experiments that are included in the bibtex file and select a random sample
df <- mesi_bibliography |> 
  filter(citation %in% citation_keys) |>
  sample_n(20)|> 
  select(exp, citation) |> 
  arrange(citation) |>
  mutate(citation = paste0('\\', "cite{", citation, "}"))
```  

## Create table as Latex code

The data frame created above can now be written as a Latex table as Latex source code, here written to file `latex/table.tex`. This function returns the path of the file.
```{r}
create_table_latex(
  df, 
  caption = "This is an example of a Caption text", 
  filn = here("latex/table.tex") 
  )
```

An additional step is necessary to make the table `.tex` file compatible with Latex. The cleaned table is here written to `latex/table_clean.tex`.
```{r}
# Read the .tex file
lines <- readLines(here("latex/table.tex"))

# Apply the processing function to each line
modified_lines <- process_cite_lines(lines)

# Write the modified lines to a new .tex file
writeLines(modified_lines, here("latex/table_clean.tex"))
```

It may be necessary to manually correct other special characters manually in `latex/table_clean.tex` before including it into your document.

## Create table as a PDF

Once it's ready to be included (Latex-readable), it can be placed in a Latex document (`latex/example.tex`) using `\input{table_clean.tex}` in the tex source.

Compile the `.tex` file for example from the terminal with `pdflatex example.tex` and `bibtex example`. Make sure that you change into the subdirectory `latex/` before executing the compilation commands. The experiments reference table with references and a bibliography at the bottom of the document has now been included in the PDF `latex/example.pdf`.
